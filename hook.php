<?php
// –ø–æ–¥—Ä—É–±–∞–µ–º API
require __DIR__ . '/vendor/autoload.php';
require __DIR__ . '/credentials.php';
require __DIR__ . '/functions.php';

$bot = new \TelegramBot\Api\Client($bot_api_key,null);
if($_GET["bname"] == $bot_username){
    $bot->sendMessage($bot_username, "–¢–µ—Å—Ç");
}

// –µ—Å–ª–∏ –±–æ—Ç –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - —Ä–µ–≥–∏—Å—Ç–∏—Ä—É–µ–º
if(!file_exists("registered.trigger")){
    /**
     * —Ñ–∞–π–ª registered.trigger –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞.
     * –µ—Å–ª–∏ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∑–Ω–∞—á–∏—Ç –±–æ—Ç –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
     */

    // URl —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    $result = $bot->setWebhook($hook_url);
    if($result){
        file_put_contents("registered.trigger",time()); // —Å–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–∞–±—ã –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    } else die("–æ—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
}

// –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
// –ø–∏–Ω–≥. –¢–µ—Å—Ç–æ–≤–∞—è
$bot->command('ping', function ($message) use ($bot) {
    $bot->sendMessage($message->getChat()->getId(), 'pong!');
});

$keyboards = [
    "start" => [
        [
            ["go", "text" => "–ü–æ–µ—Ö–∞–ª–∏"]
        ]
    ],
    "haveCode" => [
        [
            [
                ['callback_data' => 'myFriend_yes', 'text' => '–î–∞ üòÉ'],
                ['callback_data' => 'myFriend_no', 'text' => '–ù–µ—Ç, —è —Ç—É—Ç –ø–µ—Ä–≤—ã–π']
            ]
        ]
    ],
    "mainMenu" =>[
        [
            ["text" => "–ü—Ä–æ—Ñ–∏–ª—å"],
            ["text" => "–ö–∞—Ä—Ç–∞"]
        ],
        [
            ["text" => "–ü—Ä–æ–π—Ç–∏ –æ—Ç—Ä–µ–∑–æ–∫ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞"]
        ]
    ],
    "goToMainMenu" => [
        [
            ["back", "text" => "–í–µ—Ä–Ω—É—Ç—å—Å—è"]
        ]
    ],
    "mapMenu" => [
        [
            ["text" => "–°—Ö–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π"],
            ["text" => "–û–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–æ–≤"]
        ],
        [
            ["text" => "–ö–∞—Ä—Ç–∏–Ω–∞ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞"]
        ],
        [
            ["text" => "–í–µ—Ä–Ω—É—Ç—å—Å—è"]
        ]
    ],
    "goToMap" => [
        [
            ["text" => "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ä–∞–∑–¥–µ–ª –∫–∞—Ä—Ç–∞"]
        ],
        [
            ["text" => "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
        ]
    ],
    "labirint" => [
        [
            ["text" => "–¶–µ–ª—å –Ω–µ–¥–µ–ª–∏"],
            ["text" => "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"],
            ["text" => "–†–µ—Å—É—Ä—Å—ã"]
        ],
        [
            ["text" => "–î–Ω–µ–≤–Ω–∏–∫"],
            ["text" => "–¢—Ä–µ–∫–µ—Ä—ã"],
            ["text" => "–ó–∏–≥–∑–∞–≥–∏ –¥–Ω—è"]
        ],
        [
            ["text" => "–í–´–ë–ò–†–ê–ô –ü–û–í–û–†–û–¢"]
        ],
        [
            ["text" => "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
        ]
    ],
    "direction" => [
        [
            ["text" => "–í–ª–µ–≤–æ"],
            ["text" => "–ü—Ä—è–º–æ"],
            ["text" => "–í–ø—Ä–∞–≤–æ"]
        ]
    ]
];

function checkFriend($message) {
    global $bot;
//    $keyboard = new \TelegramBot\Api\Types\Inline\InlineKeyboardMarkup(
//        [
//            [
//                ['callback_data' => 'myFriend_yes', 'text' => '–î–∞ üòÉ'],
//                ['callback_data' => 'myFriend_no', 'text' => '–ù–µ—Ç, —è —Ç—É—Ç –ø–µ—Ä–≤—ã–π']
//            ]
//        ]
//    );
    $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
        [
            [
                ['callback_data' => 'myFriend_yes', 'text' => '–î–∞ üòÉ'],
                ['callback_data' => 'myFriend_no', 'text' => '–ù–µ—Ç, –∫–∞–∫–æ–π –∫–æ–¥?']
            ]
        ],null, true
    );
    $bot->sendMessage($message->getChat()->getId(), "–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∫–æ–¥ –æ—Ç –¥—Ä—É–≥–∞?",false, null, null, $keyboard);
}

// –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
$bot->command('start', function ($message) use ($bot, $keyboards, $conn) {
    $from = $message->getFrom();
    $user_id    = $from->getId();
    $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['start'], null, true);

    $sql = "SELECT name, user_id from users where user_id='".$user_id."'";
    $result = $conn->query($sql);

    if ($result->num_rows > 0) {
        while($row = $result->fetch_assoc()) {
            $bot->sendMessage($message->getChat()->getId(), '–¢—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, '.$row['name'], null, false, null, $keyboard);
        }
    } else {
        $sql = "INSERT INTO users (name, lastname, username, previousCommand, user_id)
VALUES ('".$from->getFirstName()."','".$from->getLastName()."','".$from->getUsername()."', 'start', '".$user_id."')";
        if ($conn->query($sql) === TRUE) {
            $answer = '–ù—É, —á—Ç–æ, '.$from->getFirstName().', –≥–æ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ —Å–æ
—Å–≤–æ–∏–º –î—Ä—É–≥–æ–º –ø–æ –õ–∞–±–∏—Ä–∏–Ω—Ç—É –î—Ä—É–∂–±—ã? –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ—é
–î—Ä—É–∂–±—É –Ω–∞ –ø—Ä–æ—á–Ω–æ—Å—Ç—å, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∞—à–∞ –î—Ä—É–∂–±–∞ –Ω–µ
—Ç–æ–∫—Å–∏—á–Ω–∞ –¥–ª—è –æ–±—â–µ—Å—Ç–≤–∞ –∏ –≤—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏
—á—É–∂–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ù–∞—É—á–∏—Ç—å—Å—è —Å–æ–Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤—É –∏ –ø–æ–º–æ—á—å
—Å–≤–æ–µ–º—É –î—Ä—É–≥—É –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Å–≤–æ–∏ —Å—Ç—Ä–∞—Ö–∏, –∏ –Ω–∞–∫–æ–Ω–µ—Ü, –Ω–∞–π—Ç–∏
–≤—ã—Ö–æ–¥, —Å—Ç–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è–º–∏ –∏ –≤—ã–∏–≥—Ä–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑.

–í—Å–µ —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ —ç—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å —Å–æ–±–æ–π —Å–≤–æ–µ–≥–æ –õ—É—á—à–µ–≥–æ
–î—Ä—É–≥–∞! –ó–∞–ø–∞—Å—Ç–∏—Å—å –æ—Å–æ–±—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏, –≤—ã–±—Ä–∞—Ç—å
–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—É–±–æ–∫ –Ω–∏—Ç–æ–∫, —Å–æ–±—Ä–∞—Ç—å
–∫—É—Å–æ—á–∫–∏ –æ–±—â–µ–π –∫–∞—Ä—Ç—ã –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—è —Ä–∞–∑–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
–≤–º–µ—Å—Ç–µ —Å –î—Ä—É–≥–æ–º –Ω–∞–π—Ç–∏ –≤—ã—Ö–æ–¥ –∏–∑ –õ–∞–±–∏—Ä–∏–Ω—Ç–∞.';

            $bot->sendMessage($message->getChat()->getId(), $answer, null, false, null, $keyboard);
        } else {
            $bot->sendMessage($message->getChat()->getId(), "Error: ".$sql."<br>".$conn->error);
        }
    }
});

// –ø–æ–º–æ—â—å
$bot->command('help', function ($message) use ($bot) {
    $answer = '–ö–æ–º–∞–Ω–¥—ã:
/help - –ø–æ–º–æ—â—å';
    $bot->sendMessage($message->getChat()->getId(), $answer);
});

// –ö–Ω–æ–ø–∫–∏ —É —Å–æ–æ–±—â–µ–Ω–∏–π
$bot->command("ibutton", function ($message) use ($bot, $keyboards) {
    $keyboard = new \TelegramBot\Api\Types\Inline\InlineKeyboardMarkup($keyboards['haveCode']);

    $bot->sendMessage($message->getChat()->getId(), "—Ç–µ—Å—Ç", false, null,null,$keyboard);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —É —Å–æ–æ–±—â–µ–Ω–∏–π
$bot->on(function($update) use ($bot, $callback_loc, $find_command, $keyboards, $conn){
    $callback = $update->getCallbackQuery();
    $message = $callback->getMessage();
    $username = $message->getFrom()->getUsername();
    $chatId = $message->getChat()->getId();
    $data = $callback->getData();

    if($data == "myFriend_yes"){
        $sql = "UPDATE users SET previousCommand='myFriend_yes' WHERE username='" . $username . "'";
        $bot->sendMessage($chatId, $sql);
        if ($conn->query($sql) === TRUE) {
            $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mainMenu'], null, true);
            $bot->sendMessage($chatId, '–í–≤–µ–¥–∏ –∫–æ–¥ –Ω–∏–∂–µ:', null, false, null, $keyboard);
            $bot->answerCallbackQuery($callback->getId());
        } else {
            $bot->sendMessage($chatId, '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º—ã –Ω–∞–¥ —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞–µ–º');
            $bot->answerCallbackQuery($callback->getId());
        }
    }
    if($data == "myFriend_no"){
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
            [
                [
                    ["test", "text" => "Test"]
                ]
            ], null, true);
        $bot->sendMessage($chatId, "–í–æ—Ç —Ç–≤–æ–π –∫–æ–¥ –¥–ª—è –¥—Ä—É–≥–∞, –≤—ã—à–ª–∏ –µ–º—É!", null, false, null, $keyboard);
        $bot->answerCallbackQuery($callback->getId());
    }
},function($update){
    $callback = $update->getCallbackQuery();
    if (is_null($callback) || !strlen($callback->getData()))
        return false;
    return true;
});

// Reply-–ö–Ω–æ–ø–∫–∏
$bot->command("buttons", function ($message) use ($bot) {
    $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup([[["text" => "–∫–∞–∫ –¥–µ–ª–∞"], ["text" => "–∫—É—Ä—Å—ã –≤–∞–ª—é—Ç—ã"]]], true, true);

    $bot->sendMessage($message->getChat()->getId(), "—Ç–µ—Å—Ç", false, null,null, $keyboard);
});

// –û—Ç–ª–æ–≤ –ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π + –æ–±—Ä–∞–±—Ç–∫–∞ reply-–∫–Ω–æ–ø–æ–∫
$bot->on(function($Update) use ($bot, $conn, $keyboards){
    $message = $Update->getMessage();
    $chatId = $message->getChat()->getId();
    $user_id = $message->getFrom()->getId();
    $mtext = $message->getText();

    if(mb_stripos($mtext,"–ü–æ–µ—Ö–∞–ª–∏") !== false){
        checkFriend($message);
    }
    elseif(mb_stripos($mtext,"–î–∞ üòÉ") !== false){
        $res = setPreviousCommand($user_id,'setTeamCode');
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardRemove(true);
        if ($res === TRUE) {
            $bot->sendMessage($message->getChat()->getId(), '–í–≤–µ–¥–∏ –∫–æ–¥ –Ω–∏–∂–µ:', false, null,null, $keyboard);
        } else {
            $bot->sendMessage($message->getChat()->getId(), '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º—ã –Ω–∞–¥ —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞–µ–º', false, null,null, $keyboard);
        }
    }
    elseif(mb_stripos($mtext,"–ù–µ—Ç, –∫–∞–∫–æ–π –∫–æ–¥?") !== false){
        $code = random_strings();
        $result = setTeamCode($user_id, $code);
        if ($result === TRUE) {
            $res = setPreviousCommand($user_id,'setTeamName');
            $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardRemove(true);
            if ($res === TRUE) {
                $bot->sendMessage($message->getChat()->getId(), "–î–µ—Ä–∂–∏ –∫–æ–¥. –û—Ç–ø—Ä–∞–≤—å –µ–≥–æ –¥—Ä—É–≥—É:");
                $bot->sendMessage($message->getChat()->getId(), "*".$code."*", 'markdown', false, null);
                $bot->sendMessage($chatId, '–î–∞–≤–∞–π –Ω–∞–∑–æ–≤–µ–º –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É:',false, null,null, $keyboard);
            } else {
                $bot->sendMessage($message->getChat()->getId(), '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º—ã –Ω–∞–¥ —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞–µ–º',false, null,null, $keyboard);
            }
        } else {
            $bot->sendMessage($chatId, $result);
        }
    }
    elseif(mb_stripos($mtext,"–ü—Ä–æ—Ñ–∏–ª—å") !== false) {
        $res = getProfileInfo($user_id);
        if ($res !== FALSE) {
            $sum = $res['me']['rate']+$res['friend']['rate'];
            $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['goToMainMenu'], null, true);
            $message = '–í–∞—à–µ –∏–º—è: *'.$res['me']['name'].'* (—É –≤–∞—Å *'.$res['me']['rate'].'* –±–∞–ª–ª–æ–≤)
–ò–º—è –≤–∞—à–µ–≥–æ –¥—Ä—É–≥–∞: *'.$res['friend']['name'].'* (—É –≤–∞—à–µ–≥–æ –¥—Ä—É–≥–∞ *'.$res['friend']['rate'].'* –±–∞–ª–ª–æ–≤)
–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞: *'.$res['me']['teamName'].'*
–£ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã: *'.$sum.'* –±–∞–ª–ª–æ–≤';
            $bot->sendMessage($chatId, $message, 'markdown', false, null, $keyboard);
        }
    }
    elseif(mb_stripos($mtext,"–ö–∞—Ä—Ç–∞") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mapMenu'], null, true);
        $message = '*–ö–∞—Ä—Ç–∞*
–ó–¥–µ—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏';
        $bot->sendMessage($chatId, $message, 'markdown', false, null, $keyboard);

    }
    elseif(mb_stripos($mtext,"–ü—Ä–æ–π—Ç–∏ –æ—Ç—Ä–µ–∑–æ–∫ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['labirint'], null, true);
        $bot->sendMessage($chatId, '*–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*', 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–û–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–æ–≤") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['goToMap'], null, true);
        $message = '–¢—É—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–æ–≤';
        $bot->sendMessage($chatId, $message, 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–°—Ö–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π") !== false) {
        $pic = "https://bot.elen.kz/images/shema.jpg";
        $caption = '–≠—Ç–æ —Å—Ö–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π';
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['goToMap'], null, true);
        $bot->sendPhoto($chatId, $pic, $caption, null, $keyboard );

    }
    elseif(mb_stripos($mtext,"–ö–∞—Ä—Ç–∏–Ω–∞ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞") !== false) {
        $pic = "https://bot.elen.kz/images/labirint.png";
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['goToMap'], null, true);
        $caption = '–≠—Ç–æ –∫–∞—Ä—Ç–∞ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ —É—Ä–æ–≤–Ω–µ–π';
        $bot->sendPhoto($chatId, $pic, $caption, null, $keyboard );

    }
    elseif(mb_stripos($mtext,"–í–µ—Ä–Ω—É—Ç—å—Å—è") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mainMenu'], null, true);
        $bot->sendMessage($chatId, '*–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*', 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ä–∞–∑–¥–µ–ª –∫–∞—Ä—Ç–∞") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mapMenu'], null, true);
        $bot->sendMessage($chatId, '*–ö–∞—Ä—Ç–∞*', 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mainMenu'], null, true);
        $bot->sendMessage($chatId, '*–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*', 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–í–´–ë–ò–†–ê–ô –ü–û–í–û–†–û–¢") !== false) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['direction'], null, true);
        $bot->sendMessage($chatId, '*–í—ã–±–µ—Ä–∏ –∫—É–¥–∞ —Ç—ã –ø–æ–π–¥–µ—à—å*', 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–í–ª–µ–≤–æ") !== false || mb_stripos($mtext,"–ü—Ä—è–º–æ") !== false || mb_stripos($mtext,"–í–ø—Ä–∞–≤–æ") !== false ) {
        $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mainMenu'], null, true);
        $bot->sendMessage($chatId, '*–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*', 'markdown', false, null, $keyboard);
    }
    elseif(mb_stripos($mtext,"–ß—É–±–∞–∫–∞–±—Ä–∞") !== false){
        $pic='https://bot.elen.kz/images/mp4.mp4';
        $res = getAllUsers();
        if ($res !== FALSE) {
            foreach ($res as $usr) {
                try {
//                    $bot->sendAnimation($usr, $pic);
                    $bot->sendMessage($usr, "*–Ø –≤–∞—Å –≤—Å–µ—Ö —É–¥–∞–ª–∏–ª!!!*",'markdown');
                    setBlockStatus($usr, 0);
                } catch (Exception $e) {
                    setBlockStatus($usr, 1);
                }
            }
        } else {
            $bot->sendMessage($chatId, 'FALSE','markdown');
        }
    }
    elseif($mtext != '') {
        $row = getPreviousCommand($user_id);
        if ($row == 'setTeamCode') {
            $check = checkTeamCode($mtext);
            if ($check == 1) {
                $teamName = getTeamNameByCode($mtext);
                $result = setTeamCode($user_id, $mtext);
                if ($result === TRUE) {
                    $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mainMenu'], null, true);
                    if ($teamName !== NULL && $teamName !== FALSE) {
                        $bot->sendMessage($chatId, '–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞: *'.$teamName.'*', 'markdown', false, null, $keyboard);
                        setTeamName($user_id, $teamName);
                        setPreviousCommand($user_id,'welcome');
                    } else {
                        $bot->sendMessage($message->getChat()->getId(), '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º—ã –Ω–∞–¥ —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞–µ–º',false, null,null, $keyboard);
                    }
                } elseif ($result !== FALSE) {
                    $bot->sendMessage($chatId, $result);
                }
            } elseif($check > 1) {
                $bot->sendMessage($chatId, '–í –∫–æ–º–∞–Ω–¥–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ 2 –¥—Ä—É–≥–∞.');
            } else {
                $bot->sendMessage($chatId, '–£ –≤–∞—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥.');
            }
        } elseif($row == 'setTeamName') {
            $result = setTeamName($user_id, $mtext);
            if ($result === TRUE) {
                $keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup($keyboards['mainMenu'], null, true);
                $bot->sendMessage($chatId, '–ú—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã.
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Twogether Navigator, '.$mtext, null, false, null, $keyboard);
                setPreviousCommand($user_id,'welcome');
            } else {
                $bot->sendMessage($chatId, $result);
            }
        }
    }
},function($update) use ($bot) {
    $msg = $update->getMessage();
    if (is_null($msg) || !strlen($msg->getText())) {  return false;   }
    return true;
});
// –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
if(!empty($bot->getRawBody())){
    $bot->run();
}

echo "Twogether bot";
